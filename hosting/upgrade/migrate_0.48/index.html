<!DOCTYPE html>
<html id="docs" lang="en" class="">
	<head>
	<meta charset="utf-8">
<title>Migrate 0.48 - CDS - Continuous Delivery Service</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/png" href="../../../images/favicon.png">




<link rel="stylesheet" href="../../../sass/styles.css" integrity="" media="screen">
<link rel="stylesheet" href="../../../css/callouts.css">
<link rel="stylesheet" href="../../../css/auto-complete.css">
<link rel="stylesheet" href="../../../css/fontawesome.min.css">
<link rel="stylesheet" href="../../../css/asciinema-player.css">
<link rel="stylesheet" href="../../../css/solarized-light.css">

<meta name="description"
    content="CDN service The release 0.48 introduced a new CDS service called CDN. This service is dedicated to receive and store CDS’s job logs.
We created this service to be able to move out job&rsquo;s logs from CDS database to an object storage provider (more information about this list of providers here).
In this release, logs are stored both in CDN storage units and CDS database to facilitate migration. Old log data and database table will be removed in a future release.">
<meta property="og:description"
    content="CDN service The release 0.48 introduced a new CDS service called CDN. This service is dedicated to receive and store CDS’s job logs.
We created this service to be able to move out job&rsquo;s logs from CDS database to an object storage provider (more information about this list of providers here).
In this release, logs are stored both in CDN storage units and CDS database to facilitate migration. Old log data and database table will be removed in a future release.">
<meta name="twitter:description"
    content="CDN service The release 0.48 introduced a new CDS service called CDN. This service is dedicated to receive and store CDS’s job logs.
We created this service to be able to move out job&rsquo;s logs from CDS database to an object storage provider (more information about this list of providers here).
In this release, logs are stored both in CDN storage units and CDS database to facilitate migration. Old log data and database table will be removed in a future release.">
<meta property="og:url" content="/hosting/upgrade/migrate_0.48/">
<meta property="og:title" content="Migrate 0.48">
<meta name="twitter:title" content="Migrate 0.48">
<meta name="twitter:image:alt" content="CDS - Continuous Delivery Service">
<meta property="og:image" content="/images/cds-transparent.png">
<script type="text/javascript" src="../../../js/anchor-4.1.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../../js/jquery-ui-1.12.1.min.js"></script>
<script type="text/javascript" src="../../../js/bootstrap-3.3.7.min.js"></script>
<script type="text/javascript" src="../../../js/highlight.pack.js"></script>
<script>
    hljs.initHighlightingOnLoad();

</script>
<script type="text/javascript" src="../../../js/script.js"></script>
<script type="text/javascript" src="../../../js/lunr.min.js"></script>
<a id="indexJSON" href="../../../index.json"></a>

<script type="text/javascript" src="../../../js/auto-complete.js"></script>
<script type="text/javascript" src="../../../js/search.js"></script>
<script type="text/javascript" src="../../../js/asciinema-player.js"></script>

	</head>
	<body>
		<section id="hero" class="light-text no-sub">
			<a href="../../../" class="logo"></a>
				<i id="tocburger" class="fa fa-bars" onclick='$("#toc").toggle()'></i><div class="nav-buttons" data-auto-burger="primary">
				<ul class="global-nav">
					
					
					<li><a href="../../../docs/">Documentation</a></li>
					
					<li><a href="../../../hosting/" class="active">Hosting your own instance</a></li>
					
					<li><a href="../../../development/">CDS Developer Manual</a></li>
					
					<li><a href="../../../about/">About</a></li>
					
					<li><i class="fa fa-search" onclick='$("#searchbox").toggle(); $("#search-query").focus().select()'></i></li>
					<li>
						<div id="btn-gh">
							<a class="github-button" href="https://github.com/ovh/cds" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star CDS on GitHub">Star</a>
							<script async defer src="https://buttons.github.io/buttons.js"></script>
						</div>
					</li>
				</ul>
				<div id="searchbox">
					<input data-search-input id="search-query" type="text" placeholder="search...">
					<span data-search-clear=""><i class="fa fa-close"></i></span>
				</div>
			</div>

<div id="headSubMenu" class="light-text">




	

		

		
	

	

		

		
		<ul>
			
			
			
			
		</ul>
		
	

	

		

		
	

	

		

		
	

</div>


		</section>
		<section id="page-content-with-menu">
			
<div id="toc">
     <div class="toc-container">
        
        
        
        
        
            
                
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                        
                            
                        
                    
                
            
        
            
                
                    
                        
                            
                        
                    
                        
                            
                                    
                                    
                            
                        
                    
                
            
        
            
                
                    
                        
                    
                        
                    
                        
                    
                
            
        
            
                
                    
                
            
        
        
        <i class="fa fa-bars" id="tocburger" onclick='$("#toc").toggle()'></i> 
<a class="item" data-title="Upgrade your CDS Instance" href="../../../hosting/upgrade/"></a>

	
	
	
	
		
			
<a class="item" data-title="Migrate 0.48" href="../../../hosting/upgrade/migrate_0.48/"></a>

		
	





     </div>
</div>


			<div id="docsContent">
        		

<h1>Migrate 0.48</h1>



<nav id="TableOfContents">
  <ul>
    <li><a href="#cdn-service">CDN service</a></li>
  </ul>

  <ul>
    <li><a href="#other-changes">Other changes</a></li>
  </ul>
</nav>

<h2 id="cdn-service">CDN service</h2>
<p>The release 0.48 introduced a new CDS service called CDN. This service is dedicated to receive and store CDS’s job logs.</p>
<p>We created this service to be able to move out job&rsquo;s logs from CDS database to an object storage provider (more information about this list of providers <a href="../../../docs/components/cdn/">here</a>).</p>
<p>In this release, logs are stored both in CDN storage units and CDS database to facilitate migration. Old log data and database table will be removed in a future release.</p>
<h1 id="prepare-cdn-service-configuration">Prepare CDN service configuration</h1>
<ul>
<li>Init CDN configuration using <code>engine</code> binary.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ engine config new cdn &gt; cdn.toml
</code></pre></div><p>Depending your needs you can change the default configuration to use a different storage unit (see: cdn.storageUnits.storages), the default configuration is using a local unit with encryption.</p>
<ul>
<li>Generate a auth consumer for your new CDN service.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cdsctl consumer new me <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--scopes<span style="color:#f92672">=</span>Service,Worker,RunExecution <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cdn&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Consumer for cdn service&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--groups<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;shared.infra&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--no-interactive

Builtin consumer successfully created, use the following token to sign in:
xxxxxxxx.xxxxxxx.4Bd9XJMIWrfe8Lwb-Au68TKUqflPorY2Fmcuw5vIoUs5gQyCLuxxxxxxxxxxxxxx

$ engine config edit --output cdn.toml cdn.toml cdn.api.token<span style="color:#f92672">=</span>xxxxxxxx.xxxxxxx.4Bd9XJMIWrfe8Lwb-Au68TKUqflPorY2Fmcuw5vIoUs5gQyCLuxxxxxxxxxxxxxx
</code></pre></div><ul>
<li>Generate a auth consumer for CDS unit for CDN</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cdsctl consumer new me <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--scopes<span style="color:#f92672">=</span>Project,Run <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cdn-storage-cds&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Consumer for cds storage unit&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--groups<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;shared.infra&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--no-interactive

Builtin consumer successfully created, use the following token to sign in:
xxxxxxxx.xxxxxxx.4Bd9XJMIWrfe8Lwb-Au68TKUqflPorY2Fmcuw5vIoUs5gQyCLuxxxxxxxxxxxxxx

$ engine config edit --output cdn.toml cdn.toml cdn.storageUnits.storages.cds.token<span style="color:#f92672">=</span>xxxxxxxx.xxxxxxx.4Bd9XJMIWrfe8Lwb-Au68TKUqflPorY2Fmcuw5vIoUs5gQyCLuxxxxxxxxxxxxxx
</code></pre></div><p>The CDS unit will be useful to migrate logs from CDS database to CDN.</p>
<h1 id="init-cdn-database">Init CDN database</h1>
<p>CDN service will require a Postgres database, you can use the same database for CDS API and CDN with different schema or use two distinct databases.
To init the database please follow the database management guide <a href="../../../hosting/database/">here</a>.</p>
<h1 id="start-cdn-service">Start CDN service</h1>
<p>By default CDN log processing and migration is active for all projects and you&rsquo;ll have to start the migration process manually.</p>
<p>Migration will be executed in two steps, the first one will populate the CDN database from known log items. Then log content will be accessible through the temporary CDS unit and CDN will start to sync your storage unit with CDS unit.</p>
<p>If your CDS instance handles a lot of workflows, the migration may take a long time, thanks to the feature flip, you will be able to manually define the list of CDS projects that should use CDN to gradually migrate your projects to CDN.</p>
<ul>
<li>(Optional) Set feature flipping for CDN logs to migrate only some projects.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat <span style="color:#e6db74">&lt;&lt;EOF &gt; feature.yaml
</span><span style="color:#e6db74">name: cdn-job-logs
</span><span style="color:#e6db74">rule: return project_key == &#34;PROJECT1&#34; or project_key == &#34;PROJECT2&#34;
</span><span style="color:#e6db74">EOF</span>
cdsctl admin feature import feature.yaml
</code></pre></div><ul>
<li>Start CDN service and migration.</li>
</ul>
<p>At this step, you will be able to start the CDN service. It will start processing logs for activated projects.</p>
<p>Start migration using the command line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cdsctl admin cdn migrate
</code></pre></div><p>This will only migrate activated projects. If you are using feature flipping to gradually migrate your projects, you will need to rerun this command each time you change this list of projects.</p>
<p>You can follow the migration from CDN logs or with the CDS command line:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ cdsctl admin cdn status
</code></pre></div><p><img src="../../../images/cdn_status.png" alt="CDN_STATUS"></p>
<h2 id="other-changes">Other changes</h2>
<ul>
<li>The CDS migrate service is now able to manage SQL migrations on both API and CDN databases. Its configuration file format changed to add CDN database config.
Please use the following command to generate a config example and update your existing one to this new format.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ engine config new migrate
</code></pre></div><ul>
<li>Workflow Run will now contains a snapshot of required secrets when starting. This allows changing a secret on CDS entities without breaking existing runs. A migration script will generate this snapshot for recent Workflow Runs (&lt; 3 Months), others will be set to read only mode.</li>
<li>CDS UI service will now proxy both API and CDN calls, please add the following lines in your existing config.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># CDN µService URL</span>
cdnURL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://localhost:8089&#34;</span> <span style="color:#75715e"># change this URL if needed to match CDN address</span>
</code></pre></div>



			</div>
		</section><footer>
			<main>
			<a href="https://www.ovh.com"><img src="https://ovh.github.io/cds/images/logo-ovh-white-72DPI.png"></a>
			<div>
				The CDS logos are copyrighted.
				Icons made by <a href="https://www.flaticon.com/authors/eucalyp">Eucalyp</a> 
				from <a href="https://www.flaticon.com/">www.flaticon.com</a>
			</div>
			</main>
		</footer>

	</body>
</html>
